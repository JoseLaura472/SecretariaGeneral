-- NOMBRE: PROCEDIMIENTOS SECRETARIA
-- AUTOR: JUAN JOSÉ LAURA BILBAO

-- ENCRYPTADOR DE CONTRASEÑAS
CREATE EXTENSION IF NOT EXISTS pgcrypto;
------------------->

-- INSERTAR USUARIO CON ENCRYPTACION
CREATE OR REPLACE FUNCTION public.insertar_adm(usuariou character varying, contrasenau character varying, id_personau integer, id_consejou integer)
 RETURNS Integer
 LANGUAGE plpgsql
AS $function$
declare
    respuesta Integer;
begin
	
	if(select count(usuario.id_persona) from usuario where usuario.id_persona = id_personaU or usuario.usuario_nom  = usuarioU) = 0	
	then
	INSERT INTO public.usuario
	(contrasena, estado, usuario_nom, id_persona, id_consejo)
	VALUES(crypt(contrasenaU, gen_salt('bf')), 'A', usuarioU, id_personaU, id_consejou)
	returning id_usuario into respuesta;
	else
	respuesta:= 0;
	end if;

 	return respuesta;
END;
$function$;

------------------------( Usuario_nom, contrasena, id_persona)
select * from insertar_adm('ADM', '123', 1, 1) 
------------------->

-- LOGIN
CREATE OR REPLACE FUNCTION public.validar_adm(usuariou character varying, contrasenau character varying)
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
declare
    res Integer;
begin
	select usuario.id_usuario into res from usuario where usuario.usuario_nom  = usuarioU and usuario.contrasena = crypt(contrasenaU, contrasena);
	return res;
END;
$function$;
------------------->

-- REGISTRO DE CONSEJO

CREATE OR REPLACE FUNCTION public.insertar_consejo(nombrecon character varying, siglacon character varying)
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
DECLARE
    respuesta integer;
BEGIN
	if(select count(consejo.nombre_consejo) from consejo where consejo.nombre_consejo  = nombrecon) = 0
	then 
	INSERT INTO public.consejo
	(nombre_consejo, sigla_consejo, estado_consejo)
	VALUES(nombrecon, siglacon, 'A');
	respuesta := 1;
	return respuesta;
 	end if;
 
 	if(select count(consejo.nombre_consejo) from consejo where consejo.nombre_consejo  = nombrecon) <> 0
 	then
 	respuesta := 0;
 	return respuesta;
 	end if;
END;
$function$;
------------------->